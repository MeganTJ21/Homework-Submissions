---
title: 'Bios 6301: Assignment 8'
author: 'Megan Taylor'
output: pdf_document
---

*Due Tuesday, 16 November, 1:00 PM*

$5^{n=day}$ points taken off for each day late.

30 points total.

Submit a single knitr file (named `homework8.rmd`), along with a valid PDF output file. Inside the file, clearly indicate which parts of your responses go with which problems (you may use the original homework document as a template). Add your name as `author` to the file's metadata section. Raw R code/output or word processor files are not acceptable.

Failure to name file `homework8.rmd` or include author name may result in 5 points taken off.

### Question 1 ###

**15 points**

Install the `readxl` package and run the following

```{r}
fn <- 'icd10.xlsx'
if(file.access(fn, mode = 4) == -1) {
    url <- "https://www.cdc.gov/nhsn/xls/icd10-pcs-pcm-nhsn-opc.xlsx"
    download.file(url, destfile = fn, mode = 'wb')
}
dat <- readxl::read_excel(fn, sheet = 2)
```

1. Show the class of `dat`. (1 point)

```{r, echo=TRUE}
class(dat)
```

2. Show the methods available for objects of the given class (if there are multiple classes, show methods for all classes). (3 points)

```{r, echo=TRUE}
methods(,"tbl_df")
methods(,"tbl")
methods(,'data.frame')
```

3. If you call `print(dat)`, what print method is being dispatched? (1 point)

```{r, echo=TRUE, eval=FALSE}
methods(print)
```

print.tbl_df

4. Set the class of `dat` to be a data.frame. (1 point)

```{r, echo=TRUE}
class(dat) = 'data.frame'
class(dat)
```

5. If you call `print(dat)` again, what print method is being dispatched? (1 point)

print.data.frame

Define a new generic function `nUnique` with the code below.

```{r}
nUnique <- function(x) {
    UseMethod('nUnique')
}
```

6. Write a default method for `nUnique` to count the number of unique values in an element. (2 points)

```{r, echo=TRUE}
nUnique.default <- function(x) {
  length(unique(x))
}
```

7. Check your function (2 points)

```{r}
nUnique(letters) # should return 26
nUnique(sample(10, 100, replace = TRUE)) # should return 10 (probably)
```

8. Write a data.frame method for `nUnique` to operate on data.frame objects.
This version should return counts for each column in a data.frame. (2 points)

```{r, echo=TRUE}
nUnique.data.frame <- function(df) {
  a <- c()
  for (n in 1:ncol(df)){
    a <- c(a, length(unique(df[,n])))
  }
  a
}
```

9. Check your function (2 points)

```{r}
nUnique(dat)
```

### Question 2 ###

**15 points**

Programming with classes.  The following function will generate random patient information.

```{r}
makePatient <- function() {
  vowel <- grep("[aeiou]", letters)
  cons <- grep("[^aeiou]", letters)
  name <- paste(sample(LETTERS[cons], 1), sample(letters[vowel], 1), sample(letters[cons], 1), sep='')
  gender <- factor(sample(0:1, 1), levels=0:1, labels=c('female','male'))
  dob <- as.Date(sample(7500, 1), origin="1970-01-01")
  n <- sample(6, 1)
  doa <- as.Date(sample(1500, n), origin="2010-01-01")
  pulse <- round(rnorm(n, 80, 10))
  temp <- round(rnorm(n, 98.4, 0.3), 2)
  fluid <- round(runif(n), 2)
  list(name, gender, dob, doa, pulse, temp, fluid)
}
```

1. Create an S3 class `medicalRecord` for objects that are a list with the named elements `name`, `gender`, `date_of_birth`, `date_of_admission`, `pulse`, `temperature`, `fluid_intake`. Note that an individual patient may have multiple measurements for some measurements.  Set the RNG seed to `8` and create a medical record by taking the output of `makePatient`.  Print the medical record, and print the class of the medical record. (5 points)

```{r, echo=TRUE}
# function that creates an s3 class medicalRecord for list with specified objects
medicalRecord <- function(x) {
  # get attributes from the makePatient list
  a <- list(name = x[[1]], gender = x[[2]], date_of_birth = x[[3]], date_of_admission = x[[4]], pulse = x[[5]], temperature = x[[6]], fluid_intake = x[[7]])
  # define class
  class(a) <- "medicalRecord"
  # return the medical record
  a
}

set.seed(8)
m <- makePatient()
m1 <- medicalRecord(m)
m1
```

2. Write a `medicalRecord` method for the generic function `mean`, which returns averages for pulse, temperature and fluids. Also write a `medicalRecord` method for `print`, which employs some nice formatting, perhaps arranging measurements by date, and `plot`, that generates a composite plot of measurements over time.  Call each function for the medical record created in part 1. (5 points)

```{r, echo=TRUE}
mean.medicalRecord <- function(x){
  # pulse, temperature, fluids
  b = c(mean(x[[5]]), mean(x[[6]]), mean(x[[7]]))
  b
}

mean(m1)

print.medicalRecord <- function(x){
  print(paste('Medical Record for', x[[1]]))
  print(paste("Gender:", x[[2]]))
  print(paste("Date of Birth:", x[[3]]))
  # get the order of dates
  d <- order(x[[4]])
  for (i in d){
    # print each entry by date
    cat("\n")
    print(paste("Date of admission:", x[[4]][i]))
    print(paste("Pulse:", x[[5]][i]))
    print(paste("Temperature:", x[[6]][i]))
    print(paste("Fluid Intake:", x[[7]][i]))
  }
}

print(m1)


plot.medicalRecord <- function(x){
  # get order of dates
  d <- order(x[[4]])
  # extend the margins
  par(mar=c(5.1, 4.1, 4.1, 8.1), xpd=TRUE)
  # plot entries by date, using separate y-axis for fluid intake because scale is very different
  plot(x[[4]][d], x[[5]][d], ylim = range(x[[5]], x[[6]]), xlab = "Date of admission", ylab = "Pulse and Temp Measurement", col = "red", pch = 16)
  lines(x[[4]][d], x[[5]][d], col = 'red')
  points(x[[4]][d], x[[6]][d], col = 'blue', pch = 17)
  lines(x[[4]][d], x[[6]][d], col = 'blue')
  par(new=TRUE)
  plot(x[[4]][d], x[[7]][d], ylim = range(x[[7]]), xlab = "Date of admission", ylab = "", col = "green", pch = 15, axes = FALSE)
  lines(x[[4]][d], x[[7]][d], col = 'green')
  # add other axis and legend
  mtext("Fluid Intake",side=4,line=4) 
  axis(4, ylim=range(x[[7]]),las=1)
  legend("bottomright",inset=c(-0.3,-0.3),legend=c("Pulse","Temperature", "Fluid Intake") ,pch=c(16,17,15),col=c("red","blue","green"))
}

plot(m1)
```


3. Create a further class for a cohort (group) of patients, and write methods for `mean` and `print` which, when applied to a cohort, apply mean or print to each patient contained in the cohort. Hint: think of this as a "container" for patients.  Reset the RNG seed to 8 and create a cohort of ten patients, then show the output for `mean` and `print`. (5 points)

```{r, echo=TRUE}
cohort <- function(nx) {
  c = c()
  # create a medical record for each of the number requested
  for (n in 1:nx){
    x = makePatient()
    a <- list(name = x[[1]], gender = x[[2]], date_of_birth = x[[3]], date_of_admission = x[[4]], pulse = x[[5]], temperature = x[[6]], fluid_intake = x[[7]])
  class(a) <- "medicalRecord"
  
  c = c(c, a)
  }
  class(c) <- "cohort"
  c
}

set.seed(8)
co <- cohort(10)

mean.cohort <- function(c){
  b <- c()
  for (n in 1:(length(c)/7)){
    s <- c(mean(c[[5+7*(n-1)]]), mean(c[[6+7*(n-1)]]), mean(c[[7+7*(n-1)]]))
    
    b <- c(b, s)
  }
  b
}

print.cohort <- function(c){
  for (n in 1:(length(c)/7)){
    if (n>1) cat("\n", "\n")
    print(paste('Medical Record for', c[[1+7*(n-1)]]))
    print(paste("Gender:", c[[2+7*(n-1)]]))
    print(paste("Date of Birth:", c[[3+7*(n-1)]]))
    d <- order(c[[4+7*(n-1)]])
    for (i in d){
      cat("\n")
      print(paste("Date of admission:", c[[4+7*(n-1)]][i]))
      print(paste("Pulse:", c[[5+7*(n-1)]][i]))
      print(paste("Temperature:", c[[6+7*(n-1)]][i]))
      print(paste("Fluid Intake:", c[[7+7*(n-1)]][i]))
    }
  }
}

mean(co)
print(co)
```
